
## Chapter 54. Docker Security

도커 컨테이너는 호스트와 완벽하게 격리되어 있지 않다. 컨테이너와 호스트는 같은 커널을 공유한다. 리눅스(linux) 네임스페이스를 통해 격리된다. 컨테이너는 고유한 네임스페이스를 갖는다. 모든 컨테이너는 호스트 자체에서 실행되지만, 각자의 네임스페이스에서 동작한다. 

네임스페이스 내부에 있는 프로세스는 동일한 네임스페이스에 있는 프로세스만 볼 수 있다. 다른 네임스페이스에 위치한 프로세스를 알지 못한다. 도커는 리눅스 네임스페이스를 통해 프로세스를 격리한다. 

도커는 프로세스를 실행할 때 루트(root) 사용자로 실행한다. 도커 컨테이너를 실행할 떄 루트 사용자가 아닌 다른 사용자로 실행하고 싶다면 --user 옵션을 사용한다. 

```
$ docker run --user=1000 ubuntu sleep 3600
```

도커 이미지를 만들 때 사용자를 변경할 수 있다.

```dockerfile
FROM ubuntu

USER 1000
...
```

```
$ docker build -t my-ubuntu-image .
```

```
$ docker run my-ubuntu-image slepp 3600
```

컨테이너 안의 루트 사용자가 호스트의 루트 사용자와 같은 경우 컨테이너를 통해 호스트를 제어할 수 있기 때문에 문제가 될 수 있다. 도커는 컨테이너 내 루트 사용자의 능력을 제한하는 보안 기능을 갖고 있다. 컨테이너 안의 루트 사용자는 호스트의 루트 사용자와 다르다. 도커는 보안을 구현하기 위해 리눅스의 기능을 사용한다.

루트 사용자는 시스템 내에서 무엇이든 할 수 있다. 루트 사용자가 실행한 프로세스도 마찬가지로 강력하다. 시스템에 제한 없이 접근할 수 있다. 

- 파일 수정
- 접근 제어
- 접근 권한
- 프로세스 생성 또는 죽이기
- 그룹 ID, 사용자 ID 설정
- 네트워크 포트 제어
- 네트워크 브로드캐스트(broadcast)
- 시스템 시계 제어

리눅스의 다양한 기능은 아래 파일을 통해 확인할 수 있다.

```
/usr/include/linux/capability.h
```

기본 값으로 도커(docker)는 컨테이너를 실행할 때 기능 모임이 제한되어 있다. 컨테이너 안에서 실행되는 프로세스는 호스트를 재부팅하거나 같은 호스트에서 실행되는 컨테이너를 제어할 수 있는 권한이 없다. 컨테이너에게 추가적인 권한을 부여하고 싶은 경우 컨테이너 실행 명령에 --cap-add 옵션을 사용하면 된다.

```
$ docker run --cap-add MAC_ADMIN ubuntu
```

--cap-drop 옵션으로 특정 권한을 제거할 수도 있다.

```
$ docker run --cap-drop KILL ubuntu
```

모든 권한이 활성화 된 컨테이너를 실행하고 싶은 경우 --privileged 옵션을 사용할 수 있다.

```
$ docker run --privileged KILL ubuntu
```
